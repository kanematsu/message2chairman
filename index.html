<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>AR Messages</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
        background: #0b1220;
        color: #e2e8f0;
      }

      #hint {
        position: fixed;
        left: 50%;
        bottom: 20px;
        transform: translateX(-50%);
        padding: 10px 14px;
        background: rgba(11, 18, 32, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 10px;
        font-size: 14px;
        letter-spacing: 0.2px;
        backdrop-filter: blur(6px);
        z-index: 2;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="hint">マーカーを映しながらタップするとメッセージが切り替わります</div>

    <a-scene
      embedded
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true; antialias: true"
      arjs="sourceType: webcam; detectionMode: mono; debugUIEnabled: false;"
      device-orientation-permission-ui="enabled: false"
    >
      <a-assets>
        <canvas id="text-canvas" width="1024" height="512"></canvas>
      </a-assets>

      <a-marker id="marker" type="hiro" emitevents="true">
        <a-entity position="0 0.6 0">
          <a-plane
            id="message-plane"
            width="3.2"
            height="1.6"
            material="src: #text-canvas; side: double; transparent: true"
            position="0 0 0"
            rotation="-20 0 0"
          ></a-plane>
        </a-entity>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      (function () {
        const messages = [
          "ようこそ！マーカーに重ねて1枚目のメッセージです。",
          "2枚目：タップで順番に切り替わります。",
          "3枚目：Safariでの動作を確認してください。",
          "4枚目：GitHub Pagesに配置してお試しください。",
        ];

        const scene = document.querySelector("a-scene");
        const plane = document.getElementById("message-plane");
        const canvas = document.getElementById("text-canvas");
        const ctx = canvas.getContext("2d");
        let index = 0;

        const wrapText = (value, maxWidth) => {
          const lines = [];
          let line = "";
          for (const char of value) {
            const testLine = line + char;
            const width = ctx.measureText(testLine).width;
            if (width > maxWidth && line !== "") {
              lines.push(line);
              line = char;
            } else {
              line = testLine;
            }
          }
          if (line) lines.push(line);
          return lines;
        };

        const updateMessage = () => {
          const w = canvas.width;
          const h = canvas.height;
          ctx.clearRect(0, 0, w, h);
          ctx.fillStyle = "#ffde59";
          ctx.fillRect(0, 0, w, h);

          ctx.fillStyle = "#0a0a0a";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.font = "bold 72px 'Hiragino Sans', 'Noto Sans JP', 'Noto Sans CJK JP', 'Yu Gothic', 'Helvetica Neue', Arial, sans-serif";

          const lines = wrapText(messages[index], w * 0.8);
          const lineHeight = 88;
          const startY = h / 2 - ((lines.length - 1) * lineHeight) / 2;
          lines.forEach((line, i) => {
            ctx.fillText(line, w / 2, startY + i * lineHeight);
          });

          const mesh = plane.getObject3D("mesh");
          if (mesh && mesh.material && mesh.material.map) {
            mesh.material.map.needsUpdate = true;
          }
        };

        const advanceMessage = () => {
          index = (index + 1) % messages.length;
          updateMessage();
        };

        const attachListeners = () => {
          const handler = () => advanceMessage();
          const touchHandler = (event) => {
            event.preventDefault();
            advanceMessage();
          };
          scene.addEventListener("click", handler);
          scene.addEventListener("touchstart", touchHandler, { passive: false });
        };

        if (scene.hasLoaded) {
          updateMessage();
          attachListeners();
        } else {
          scene.addEventListener("loaded", () => {
            updateMessage();
            attachListeners();
          });
        }
      })();
    </script>
  </body>
</html>
